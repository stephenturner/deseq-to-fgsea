---
title: "DESeq results to pathways in 60 Seconds with the **fgsea** package"
author: "Stephen Turner"
date: "`r Sys.Date()`"
output: 
  html_document: 
    # code_folding: show
    fig_height: 8
    fig_width: 8
    warning: FALSE
    message: FALSE
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: false
    # theme: flatly
    # theme: default
    # theme: cerulean
    # theme: journal
    # theme: readable
    # theme: spacelab
    # theme: united
    # theme: cosmo
    # theme: lumen
    # theme: paper
    # theme: sandstone
    # theme: simplex
    # theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, cache=TRUE)
```

```{css, echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}

blockquote {
  font-size: 90%;
}
```

Here I'll show you how to take results from DESeq and quickly assess for enrichment of pathways using the [fgsea package](http://bioconductor.org/packages/fgsea) for fast preranked gene set enrichment analysis (GSEA).

# FGSEA on DESeq results (human)

First, let's start with a human dataset.

## Load some results from DESeq2

Load some results from DESeq2 (generated using `results(..., tidy=TRUE)`). See the [appendix](#appendix) section at the end for how this data was generated. 

```{r}
library(tidyverse)
res <- read_csv("data/deseq-results-tidy-human-airway.csv")
res
```

Map Ensembl gene IDs to symbol. First create a mapping table.

```{r}
library(org.Hs.eg.db)
ens2symbol <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=res$row, 
                                    columns="SYMBOL",
                                    keytype="ENSEMBL")
ens2symbol <- as_tibble(ens2symbol)
ens2symbol
```

Now join them. 

```{r}
res <- inner_join(res, ens2symbol, by=c("row"="ENSEMBL"))
res
```

Further, all you'll care about later on is the gene symbol and the test statistic. Get just those, and remove the `NA`s. Finally, if you have multiple test statistics for the same symbol, you'll want to deal with that in some way. Here I'm just averaging them. 

```{r}
res2 <- res %>% 
  dplyr::select(SYMBOL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(SYMBOL) %>% 
  summarize(stat=mean(stat))
res2
```

## Using the fgsea package

We're going to use the [fgsea package](http://bioconductor.org/packages/fgsea) for fast preranked gene set enrichment analysis (GSEA). See the [preprint](https://www.biorxiv.org/content/early/2016/06/20/060012) for more details. From the abstract:

> Gene set enrichment analysis is a widely used tool for analyzing gene expression data. However, current implementations are slow due to a large number of required samples for the analysis to have a good statistical power. In this paper we present a novel algorithm, that efficiently reuses one sample multiple times and thus speeds up the analysis. We show that it is possible to make hundreds of thousands permutations in a few minutes, which leads to very accurate p-values. This, in turn, allows applying standard FDR correction procedures, which are more accurate than the ones currently used. 

```{r}
library(fgsea)
```

The `fgsea()` function requires a list of gene sets to check, and a named vector of gene-level statistics, where the names should be the same as the gene names in the pathways list. First, let's create our named vector of test statistics. See `?tibble::deframe` for help here - `deframe()` converts two-column data frames to a named vector or list, using the first column as name and the second column as value.

```{r}
ranks <- deframe(res2)
head(ranks, 20)
```


Let's use the [Hallmark gene set](http://software.broadinstitute.org/gsea/msigdb/collection_details.jsp#H) from MSigDB. Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. The `gmtPathways()` function will take a GMT file you [downloaded from MSigDB](http://software.broadinstitute.org/gsea/downloads.jsp) and turn it into a list. Each element in the list is a character vector of genes in the pathway.

```{r}
# Load the pathways into a named list
pathways.hallmark <- gmtPathways("data/msigdb/h.all.v6.2.symbols.gmt")

# Look at them all if you want (uncomment)
# pathways.hallmark

# Show the first few pathways, and within those, show only the first few genes. 
pathways.hallmark %>% 
  head() %>% 
  lapply(head)
```

Now, run the fgsea algorithm with 1000 permutations:

```{r}
fgseaRes <- fgsea(pathways=pathways.hallmark, stats=ranks, nperm=1000)
```

Tidy the results:

```{r}
fgseaResTidy <- fgseaRes %>%
  as_tibble() %>%
  arrange(desc(NES))
fgseaResTidy
```

Plot the normalized enrichment scores. Color the bar indicating whether or not the pathway was significant:

```{r}
ggplot(fgseaResTidy, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark pathways NES from GSEA") + 
  theme_minimal()
```

The [Interferon Alpha Response](http://software.broadinstitute.org/gsea/msigdb/cards/HALLMARK_INTERFERON_ALPHA_RESPONSE.html) gene set was significantly upregulated, consistent with the findings of the [original study](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0099625). 

What genes are in each of these pathways? First, get a tibble with all the pathways and the genes in them. Continue to join that back to the original data to pull out genes in the pathways. Optionally, filter the list to include only those that are significant, etc. 

```{r}
pathways.hallmark %>% 
  enframe("pathway", "SYMBOL") %>% 
  unnest() %>% 
  inner_join(res, by="SYMBOL")
```

Let's try a different set of pathways. Let's look at KEGG pathways:

```{r}
fgsea(pathways=gmtPathways("data/msigdb/c2.cp.kegg.v6.2.symbols.gmt"), ranks, nperm=1000) %>% 
  as_tibble() %>% 
  arrange(padj)
```

Or miR targets:

```{r}
fgsea(pathways=gmtPathways("data/msigdb/c3.mir.v6.2.symbols.gmt"), ranks, nperm=1000) %>% 
  as_tibble() %>% 
  arrange(padj)
```

Or GO annotations: 

```{r}
fgsea(pathways=gmtPathways("data/msigdb/c5.all.v6.2.symbols.gmt"), ranks, nperm=1000) %>% 
  as_tibble() %>% 
  arrange(padj)
```

# Non-human organisms

If you have a non-human organism, first create a table to map the fly/mouse/worm/etc gene IDs to human symbol:

```{r}
library(biomaRt)
mart <- useDataset("mmusculus_gene_ensembl", mart=useMart("ensembl"))
bm <- getBM(attributes=c("ensembl_gene_id", "hsapiens_homolog_associated_gene_name"), mart=mart) %>%
  distinct() %>%
  as_tibble() %>%
  na_if("") %>% 
  na.omit()
bm
```

Then simply join your non-human results to the table above, and continue as you did earlier now using the _human_ symbol and the associated test statistic.


# Appendix

This code was used to generate the human airway results:

```{r gen-airway-results, eval=FALSE}
library(DESeq2)
library(airway)
ddsSE <- DESeqDataSet(airway, design = ~ cell + dex)
ddsSE <- DESeq(ddsSE)
res <- results(ddsSE, tidy = TRUE)
readr::write_csv(res, path="data/deseq-results-tidy-human-airway.csv")
```
